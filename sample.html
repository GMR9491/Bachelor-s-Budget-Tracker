<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Bachelor Budget: Tracker & Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Custom Scrollbar for clean look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; 
        }

        /* Chart Container Strict Styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%; /* Adapts to grid column */
            height: 300px;
            max-height: 400px;
            margin: 0 auto;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            color: #1e293b; /* Slate-800 */
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        
        .transition-smooth {
            transition: all 0.3s ease-in-out;
        }

        /* Loading Animation for AI */
        .typing-indicator span {
            animation: blink 1.4s infinite both;
            height: 5px;
            width: 5px;
            background-color: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin: 0 1px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes blink {
            0% { opacity: 0.2; }
            20% { opacity: 1; }
            100% { opacity: 0.2; }
        }
    </style>
    
    <!-- Chosen Palette: Slate & Emerald -->
    <!-- Primary: Slate-800 (Text), Slate-50 (Bg) -->
    <!-- Accent: Emerald-500 (Positive/Money), Rose-500 (Negative/Expense) -->
    <!-- Charts: Cool blues, teals, and purples for distinction without chaos. -->

    <!-- Application Structure Plan: 
         1. Header: Brand and simple global controls.
         2. Executive Summary (KPIs): Instant view of Total Spent, Budget, Remaining.
         3. Analysis Section (Visuals): 
            - Trend Line: To show spending spikes.
            - Distribution Doughnut: To highlight categories.
         4. Interaction Zone: 
            - Manual Form: Standard inputs.
            - Transaction Log: Detailed table.
            - AI Insights: Detailed text analysis of spending habits.
    -->

    <!-- Visualization & Content Choices:
         1. KPI Cards: Immediate quantitative feedback.
         2. Line/Doughnut Charts: Trend and proportion analysis.
         3. AI Insights Block: Qualitative analysis powered by LLM.
         
         Justification: Bachelor finances need both hard data (charts) and "advice" (AI text) to be effective.
    -->
    
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">ü™ô</span>
                    <h1 class="font-bold text-xl tracking-tight text-slate-800">BachelorBudget<span class="text-emerald-500">.ai</span></h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="ai-insight-btn" class="bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white text-sm px-4 py-2 rounded-full transition-all shadow-md flex items-center">
                        <span class="mr-2">‚ú®</span> Analyze Habits
                    </button>
                    <button id="clear-data-btn" class="text-sm text-slate-500 hover:text-rose-600 transition-smooth hidden sm:block font-medium">Clear All Data</button>
                    <div class="h-8 w-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-bold border border-slate-300 cursor-pointer">
                        U
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- Intro / Context -->
        <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h2 class="text-2xl font-bold text-slate-900">Monthly Expense Report</h2>
                <p class="mt-2 text-slate-600">Tracking daily spending habits to keep your finances on track.</p>
            </div>
            <div class="mt-4 md:mt-0 bg-white p-2 rounded-lg border border-slate-200 shadow-sm flex items-center space-x-2">
                <span class="text-sm text-slate-500 font-medium px-2">Monthly Goal:</span>
                <input type="number" id="budget-input" value="25000" class="w-24 px-2 py-1 text-right font-bold text-slate-800 border-b-2 border-slate-200 focus:border-emerald-500 outline-none transition-colors" title="Click to edit budget">
                <span class="text-sm text-slate-500">INR</span>
            </div>
        </div>

        <!-- AI Insight Box (Hidden by default) -->
        <div id="ai-insight-box" class="hidden mb-8 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 border border-indigo-100 shadow-sm relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <span class="text-6xl">ü§ñ</span>
            </div>
            <h3 class="text-indigo-800 font-bold flex items-center mb-2">
                <span class="text-xl mr-2">‚ú®</span> Financial Reality Check
            </h3>
            <div id="ai-insight-content" class="text-slate-700 text-sm leading-relaxed whitespace-pre-line">
                Thinking... <span class="typing-indicator"><span></span><span></span><span></span></span>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Spent -->
            <div class="bg-white rounded-xl p-6 card-shadow border border-slate-100">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Total Spent</p>
                        <h3 class="mt-2 text-3xl font-bold text-slate-900" id="kpi-total">‚Çπ0</h3>
                    </div>
                    <span class="p-2 rounded-lg bg-rose-50 text-rose-600 text-xl">üìâ</span>
                </div>
                <p class="mt-2 text-sm text-slate-500">Includes all logged categories</p>
            </div>

            <!-- Remaining Budget -->
            <div class="bg-white rounded-xl p-6 card-shadow border border-slate-100">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Remaining</p>
                        <h3 class="mt-2 text-3xl font-bold text-emerald-600" id="kpi-remaining">‚Çπ0</h3>
                    </div>
                    <span class="p-2 rounded-lg bg-emerald-50 text-emerald-600 text-xl">üí∞</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2 mt-4">
                    <div id="budget-progress" class="bg-emerald-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Daily Average -->
            <div class="bg-white rounded-xl p-6 card-shadow border border-slate-100">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Daily Avg</p>
                        <h3 class="mt-2 text-3xl font-bold text-indigo-600" id="kpi-daily">‚Çπ0</h3>
                    </div>
                    <span class="p-2 rounded-lg bg-indigo-50 text-indigo-600 text-xl">üìÖ</span>
                </div>
                <p class="mt-2 text-sm text-slate-500">Rec. Daily Cap: <span class="font-semibold text-slate-700" id="daily-cap-display">‚Çπ800</span></p>
            </div>

            <!-- Top Category -->
            <div class="bg-white rounded-xl p-6 card-shadow border border-slate-100">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Top Drain</p>
                        <h3 class="mt-2 text-xl font-bold text-amber-600 truncate" id="kpi-top-category">Loading...</h3>
                    </div>
                    <span class="p-2 rounded-lg bg-amber-50 text-amber-600 text-xl">‚ö†Ô∏è</span>
                </div>
                <p class="mt-2 text-sm text-slate-500" id="kpi-top-amount">accounted for significant spend.</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Trend Analysis -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-2">Spending Velocity</h3>
                <p class="text-sm text-slate-500 mb-6">Daily expenditure timeline. Notice the typical "Weekend Spikes" (Sat/Sun).</p>
                
                <!-- Chart Container -->
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Composition Analysis -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-2">Wallet Share</h3>
                <p class="text-sm text-slate-500 mb-6">Breakdown by category. Watch out for "Food & Dining".</p>
                
                <!-- Chart Container -->
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Management Section: Form & Table -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Quick Add Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 sticky top-24">
                    <h3 class="text-lg font-bold text-slate-800 mb-4" id="form-title">Manual Details</h3>
                    <form id="expense-form" class="space-y-4">
                        <input type="hidden" id="edit-id" value=""> <!-- Hidden ID for Editing -->
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                            <input type="text" id="desc-input" placeholder="e.g., Pizza Night" required 
                                   class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-smooth">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Amount (‚Çπ)</label>
                            <input type="number" id="amount-input" placeholder="0.00" min="1" required 
                                   class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-smooth">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                            <select id="category-input" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-smooth bg-white">
                                <option value="Food & Dining">üçî Food & Dining</option>
                                <option value="Transport">üöï Transport</option>
                                <option value="Groceries">ü•¨ Groceries</option>
                                <option value="Entertainment">üé¨ Entertainment</option>
                                <option value="Rent & Bills">üè† Rent & Bills</option>
                                <option value="Shopping">üõçÔ∏è Shopping</option>
                                <option value="Misc">üì¶ Misc</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                            <input type="date" id="date-input" required 
                                   class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-smooth">
                        </div>

                        <div class="flex gap-2">
                            <button type="submit" id="submit-btn" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all transform active:scale-95">
                                Add Transaction
                            </button>
                            <button type="button" id="cancel-edit-btn" class="hidden w-1/3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg transition-all">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Transaction List -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h3 class="text-lg font-bold text-slate-800">Recent Transactions</h3>
                        <div class="flex gap-2">
                            <button class="filter-btn active px-3 py-1 text-sm rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200 transition-smooth font-medium border border-slate-200" data-filter="all">All</button>
                            <button class="filter-btn px-3 py-1 text-sm rounded-full bg-white text-slate-500 hover:bg-slate-50 transition-smooth font-medium border border-slate-200" data-filter="Food & Dining">Food</button>
                            <button class="filter-btn px-3 py-1 text-sm rounded-full bg-white text-slate-500 hover:bg-slate-50 transition-smooth font-medium border border-slate-200" data-filter="Transport">Travel</button>
                            <button class="filter-btn px-3 py-1 text-sm rounded-full bg-white text-slate-500 hover:bg-slate-50 transition-smooth font-medium border border-slate-200" data-filter="Entertainment">Fun</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-semibold sticky top-0">
                                <tr>
                                    <th class="px-6 py-4">Date</th>
                                    <th class="px-6 py-4">Category</th>
                                    <th class="px-6 py-4">Description</th>
                                    <th class="px-6 py-4 text-right">Amount</th>
                                    <th class="px-6 py-4"></th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list" class="divide-y divide-slate-100 text-sm text-slate-700">
                                <!-- JS will populate rows here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State Placeholder (Hidden by default) -->
                    <div id="empty-state" class="hidden p-12 text-center">
                        <span class="text-4xl">üçÉ</span>
                        <p class="mt-4 text-slate-500">Clean slate! Add expenses to see data.</p>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-auto">
        <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center text-sm text-slate-500">
            <p>&copy; 2026 Bachelor Data Analysis Inc. Powered by TEAM GMR.</p>
            <div class="flex space-x-4 mt-4 md:mt-0">
                <a href="#" class="hover:text-slate-800">Privacy Policy</a>
                <a href="#" class="hover:text-slate-800">Terms of Service</a>
            </div>
        </div>
    </footer>

    <script>
        // --- Gemini API Configuration ---
        const apiKey = ""; // Set by environment
        const systemPrompt = "You are a helpful financial assistant for a bachelor. Your goal is to be helpful, concise, and slightly humorous where appropriate.";

        async function callGemini(prompt, isJson = false) {
            if (!apiKey) {
                alert("API Key is missing. Please set up the environment.");
                return null;
            }

            try {
                // Determine format
                const generationConfig = isJson 
                    ? { responseMimeType: "application/json" }
                    : {};

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: generationConfig,
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                if (!response.ok) throw new Error('API call failed');
                
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                alert("Error connecting to Gemini. Please try again.");
                return null;
            }
        }

        // --- State Management ---
        let currentBudget = 25000; // INR - Now Mutable
        let expenses = []; // Start empty for manual entry

        let trendChart = null;
        let categoryChart = null;

        // --- Core Logic ---

        function formatCurrency(amount) {
            return '‚Çπ' + amount.toLocaleString('en-IN');
        }

        function calculateKPIs() {
            const totalSpent = expenses.reduce((sum, item) => sum + item.amount, 0);
            const remaining = currentBudget - totalSpent;
            const percentageUsed = currentBudget > 0 ? Math.min((totalSpent / currentBudget) * 100, 100) : 0;
            
            // Daily Average (assuming current date is roughly mid-month for simulation, or standard div by days present)
            const uniqueDays = new Set(expenses.map(e => e.date)).size;
            const dailyAvg = uniqueDays > 0 ? Math.round(totalSpent / uniqueDays) : 0;
            const recCap = Math.round(currentBudget / 30); // Simple 30 day calc

            // Top Category
            const catTotals = {};
            expenses.forEach(e => {
                catTotals[e.category] = (catTotals[e.category] || 0) + e.amount;
            });
            let topCat = 'None';
            let topAmt = 0;
            for (const [cat, amt] of Object.entries(catTotals)) {
                if (amt > topAmt) {
                    topAmt = amt;
                    topCat = cat;
                }
            }

            // DOM Updates
            document.getElementById('kpi-total').textContent = formatCurrency(totalSpent);
            document.getElementById('kpi-remaining').textContent = formatCurrency(remaining);
            document.getElementById('kpi-daily').textContent = formatCurrency(dailyAvg);
            document.getElementById('daily-cap-display').textContent = formatCurrency(recCap);
            
            // Budget Color Logic
            const remEl = document.getElementById('kpi-remaining');
            if (remaining < 0) {
                remEl.classList.remove('text-emerald-600');
                remEl.classList.add('text-rose-600');
            } else {
                remEl.classList.add('text-emerald-600');
                remEl.classList.remove('text-rose-600');
            }

            // Progress Bar
            const progBar = document.getElementById('budget-progress');
            progBar.style.width = percentageUsed + '%';
            if (percentageUsed > 90) progBar.className = "bg-rose-500 h-2 rounded-full transition-all duration-500";
            else if (percentageUsed > 75) progBar.className = "bg-amber-500 h-2 rounded-full transition-all duration-500";
            else progBar.className = "bg-emerald-500 h-2 rounded-full transition-all duration-500";

            // Top Category
            document.getElementById('kpi-top-category').textContent = topCat;
            document.getElementById('kpi-top-amount').textContent = topCat !== 'None' ? `${formatCurrency(topAmt)} total spend.` : 'No spending yet.';
        }

        function renderTransactionList(filter = 'all') {
            const tbody = document.getElementById('transaction-list');
            const emptyState = document.getElementById('empty-state');
            tbody.innerHTML = '';

            const filteredData = filter === 'all' 
                ? expenses.sort((a,b) => new Date(b.date) - new Date(a.date)) // Sort newest first
                : expenses.filter(e => e.category.includes(filter) || filter.includes(e.category)).sort((a,b) => new Date(b.date) - new Date(a.date));

            if (filteredData.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            filteredData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors group";
                
                // Icon mapping
                let icon = 'üì¶';
                if (item.category.includes('Food')) icon = 'üçî';
                else if (item.category.includes('Transport')) icon = 'üöï';
                else if (item.category.includes('Entertainment')) icon = 'üé¨';
                else if (item.category.includes('Rent')) icon = 'üè†';
                else if (item.category.includes('Shopping')) icon = 'üõçÔ∏è';
                else if (item.category.includes('Groceries')) icon = 'ü•¨';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-slate-500 font-mono text-xs">${item.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="mr-2">${icon}</span>${item.category}</td>
                    <td class="px-6 py-4 font-medium text-slate-800">${item.desc}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-bold text-slate-700">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4 text-right whitespace-nowrap">
                        <button onclick="editExpense(${item.id})" class="text-indigo-400 hover:text-indigo-600 transition-colors mr-3" title="Edit">‚úé</button>
                        <button onclick="deleteExpense(${item.id})" class="text-rose-400 hover:text-rose-600 transition-colors" title="Delete">‚úï</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderCharts() {
            // Data Prep for Trend Chart
            const dateMap = {};
            expenses.forEach(e => {
                dateMap[e.date] = (dateMap[e.date] || 0) + e.amount;
            });
            const sortedDates = Object.keys(dateMap).sort();
            const dailyTotals = sortedDates.map(d => dateMap[d]);

            // Trend Chart
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Daily Spending (‚Çπ)',
                        data: dailyTotals,
                        borderColor: '#6366f1', // Indigo-500
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        tension: 0.4, // Smooth curves
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#4f46e5',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            padding: 12,
                            titleFont: { size: 13 },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: (context) => ` Spent: ‚Çπ${context.raw}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });

            // Data Prep for Category Chart
            const catMap = {};
            expenses.forEach(e => {
                catMap[e.category] = (catMap[e.category] || 0) + e.amount;
            });
            const categories = Object.keys(catMap);
            const catValues = Object.values(catMap);

            // Doughnut Chart
            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();

            categoryChart = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: catValues,
                        backgroundColor: [
                            '#10b981', // Emerald
                            '#f59e0b', // Amber
                            '#6366f1', // Indigo
                            '#ef4444', // Rose
                            '#8b5cf6', // Violet
                            '#3b82f6', // Blue
                            '#94a3b8', // Slate
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 10,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            callbacks: {
                                label: (context) => {
                                    const val = context.raw;
                                    const total = context.dataset.data.reduce((a,b)=>a+b,0);
                                    const pct = Math.round((val/total)*100);
                                    return ` ${context.label}: ‚Çπ${val} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Interaction Handlers ---

        function updateBudget() {
            const input = document.getElementById('budget-input');
            const val = parseFloat(input.value);
            if(val && val > 0) {
                currentBudget = val;
                calculateKPIs();
            }
        }

        function addExpense(e) {
            e.preventDefault();
            const desc = document.getElementById('desc-input').value;
            const amount = parseFloat(document.getElementById('amount-input').value);
            const category = document.getElementById('category-input').value;
            const date = document.getElementById('date-input').value;
            const editId = document.getElementById('edit-id').value;

            if (!desc || !amount || !date) return;

            if (editId) {
                // UPDATE Existing
                const index = expenses.findIndex(e => e.id == editId);
                if (index !== -1) {
                    expenses[index] = { ...expenses[index], desc, amount, category, date };
                }
                resetForm();
            } else {
                // ADD New
                const newExpense = {
                    id: Date.now(),
                    date,
                    category,
                    desc,
                    amount
                };
                expenses.push(newExpense);
            }
            
            // Refresh UI
            calculateKPIs();
            renderTransactionList();
            renderCharts();
            
            if (!editId) {
                 document.getElementById('expense-form').reset();
                 document.getElementById('date-input').valueAsDate = new Date();
            }
        }

        function editExpense(id) {
            const item = expenses.find(e => e.id === id);
            if (!item) return;

            // Fill Form
            document.getElementById('desc-input').value = item.desc;
            document.getElementById('amount-input').value = item.amount;
            document.getElementById('category-input').value = item.category;
            document.getElementById('date-input').value = item.date;
            document.getElementById('edit-id').value = item.id;

            // UI Changes
            document.getElementById('form-title').textContent = "Edit Transaction";
            document.getElementById('submit-btn').textContent = "Update Transaction";
            document.getElementById('submit-btn').classList.remove('bg-slate-900', 'hover:bg-slate-800');
            document.getElementById('submit-btn').classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            document.getElementById('cancel-edit-btn').classList.remove('hidden');

            // Scroll to form
            document.getElementById('expense-form').scrollIntoView({ behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('expense-form').reset();
            document.getElementById('date-input').valueAsDate = new Date();
            document.getElementById('edit-id').value = "";
            
            // Reset UI
            document.getElementById('form-title').textContent = "Manual Details";
            document.getElementById('submit-btn').textContent = "Add Transaction";
            document.getElementById('submit-btn').classList.add('bg-slate-900', 'hover:bg-slate-800');
            document.getElementById('submit-btn').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        function deleteExpense(id) {
            if(confirm('Remove this transaction?')) {
                // If deleting the item currently being edited, reset form
                if (document.getElementById('edit-id').value == id) {
                    resetForm();
                }
                expenses = expenses.filter(e => e.id !== id);
                calculateKPIs();
                renderTransactionList();
                renderCharts();
            }
        }

        // --- AI Helper Functions ---

        async function handleAIInsights() {
            const container = document.getElementById('ai-insight-box');
            const content = document.getElementById('ai-insight-content');
            
            container.classList.remove('hidden');
            content.innerHTML = `Thinking... <span class="typing-indicator"><span></span><span></span><span></span></span>`;

            // Prepare data summary
            const summary = expenses.length > 0 ? expenses.map(e => `${e.date}: ${e.category} - ‚Çπ${e.amount}`).join('\n') : "No expenses recorded yet.";
            
            const prompt = `Act as a humorous but helpful financial advisor for a bachelor.
            Analyze these expenses:\n${summary}\n
            Monthly Budget: ‚Çπ${currentBudget}.
            
            Provide a response with 3 distinct sections using these emojis as headers:
            1. üïµÔ∏è‚Äç‚ôÇÔ∏è Pattern Analysis (Find 1-2 trends, e.g., ordering out too much, weekend spikes).
            2. üî• The Roast (A short, lighthearted sarcastic comment on their spending).
            3. üí° Actionable Tip (One specific way to save money based on the data).
            
            Keep the tone casual, use bold text for emphasis. Total length under 150 words. If no data, give a funny generic tip.`;

            const result = await callGemini(prompt, false);
            
            if (result) {
                // Simple markdown parsing for bold text
                const formatted = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                content.innerHTML = formatted;
            } else {
                content.innerHTML = "My brain is taking a nap. Try again later.";
            }
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Set Default Date
            document.getElementById('date-input').valueAsDate = new Date();

            // Initial Render
            calculateKPIs();
            renderTransactionList();
            renderCharts();

            // Event Listeners
            document.getElementById('expense-form').addEventListener('submit', addExpense);
            document.getElementById('cancel-edit-btn').addEventListener('click', resetForm);
            document.getElementById('ai-insight-btn').addEventListener('click', handleAIInsights);
            document.getElementById('budget-input').addEventListener('input', updateBudget);

            // Filter Buttons
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // UI Toggle
                    buttons.forEach(b => {
                        b.classList.remove('bg-slate-100', 'text-slate-700', 'active');
                        b.classList.add('bg-white', 'text-slate-500');
                    });
                    e.target.classList.remove('bg-white', 'text-slate-500');
                    e.target.classList.add('bg-slate-100', 'text-slate-700', 'active');

                    // Logic
                    const filter = e.target.getAttribute('data-filter');
                    renderTransactionList(filter);
                });
            });

            // Clear Data Button
            document.getElementById('clear-data-btn').addEventListener('click', () => {
                if(confirm("Are you sure? This will delete ALL transactions and let you start from scratch.")) {
                    expenses = [];
                    calculateKPIs();
                    renderTransactionList();
                    renderCharts();
                }
            });
        });

    </script>
</body>
</html>